<template>
  <div id="map"></div>
</template>

<script>
export default {
  mounted(){
    const map =  new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.19, lng: 127.08 },
        zoom: 14
    });

    map.addListener('idle', function(){
      map.data.forEach(function(feature){
        map.data.remove(feature);
      });

      const bounds = map.getBounds();
      const sw = bounds.getSouthWest();
      const ne = bounds.getNorthEast();

      const request = new XMLHttpRequest();
      const url = 'http://localhost:8090/api/v1/within?'
                    + 'left=' + sw.lng()
                    + '&lower=' + sw.lat()
                    + '&right=' + ne.lng()
                    + '&upper=' + ne.lat();
      request.open('GET', url);
      request.responseType = 'json';
      request.send();

      request.onload = function() {
        const geodata = request.response;
        for(var i = 0; i < geodata.length; i++){
          const latLng = new google.maps.LatLng({ lng: geodata[i].geometry.coordinates[0], lat:  geodata[i].geometry.coordinates[1] });
          map.data.add(new google.maps.Data.Feature({ geometry: latLng, properties: geodata[i].properties } ));
        }
      }
    });

    const infowindow = new google.maps.InfoWindow();
    map.data.addListener('click', function(e){
      const feature = e.feature;
      const name = feature.getProperty("name");
      const category = feature.getProperty("category");

      let content = '<div style="color:black"><b>' + name + '</b><br>' + category + '</div>';

      infowindow.setPosition(e.latLng);
      infowindow.setContent(content);
      infowindow.open(map);
    });

  }
}
</script>

<style>
  #map {
    width: 100%;
    height: 100%;
  }
</style>
